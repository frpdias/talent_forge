{
  "name": "Atendimento Fartech WhatsApp - Menu (AvisaAPI + OpenAI)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook/fartech-whatsapp",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -16,
        -16
      ],
      "id": "webhook_fartech",
      "name": "Webhook",
      "webhookId": ""
    },
    {
      "parameters": {
        "functionCode": "const inputData = $input.first().json;\n\ntry {\n  const raw = inputData.body?.jsonData;\n\n  if (!raw) {\n    return {\n      from: \"ERRO\",\n      text: \"Falha: body.jsonData nÃ£o existe\",\n    };\n  }\n\n  const obj = typeof raw === \"string\" ? JSON.parse(raw) : raw;\n\n  const senderAlt = obj?.event?.Info?.SenderAlt || \"\";\n  const sender = obj?.event?.Info?.Sender || \"\";\n  const chosenSender = senderAlt || sender;\n\n  const cleanNumber = chosenSender.includes(\"@\")\n    ? chosenSender.split(\"@\")[0]\n    : chosenSender;\n\n  const text =\n    obj?.event?.Message?.conversation ||\n    obj?.event?.Message?.extendedTextMessage?.text ||\n    \"\";\n\n  return {\n    from: cleanNumber,\n    text: text,\n  };\n} catch (e) {\n  return {\n    from: \"ERRO\",\n    text: \"Falha na normalizaÃ§Ã£o: \" + e.message,\n  };\n}\n"
      },
      "id": "normalizar_dados",
      "name": "Normalizar Dados WhatsApp",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        272,
        -16
      ]
    },
    {
      "parameters": {
        "amount": 1.5,
        "unit": "seconds"
      },
      "id": "wait_menu",
      "name": "Digitando Menu (1.5s)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        1280,
        176
      ]
    },
    {
      "parameters": {
        "functionCode": "const now = new Date();\nconst hora = now.getUTCHours() - 3;\nconst dia = now.getDay();\n\nconst emHorarioComercial = (dia >= 1 && dia <= 5 && hora >= 8 && hora < 18);\n\nreturn [{\n  emHorarioComercial\n}];"
      },
      "id": "verifica_horario",
      "name": "Verificar HorÃ¡rio Comercial",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        608,
        -176
      ]
    },
    {
      "parameters": {
        "conditions": {\n          "boolean": [\n            {\n              "value1": "={{$json[\"emHorarioComercial\"]}}",\n              "value2": true\n            }\n          ]\n        }\n      },\n      "id": "if_horario",\n      "name": "IF - Dentro do HorÃ¡rio?",\n      "type": "n8n-nodes-base.if",\n      "typeVersion": 1,\n      "position": [\n        864,\n        -176\n      ]\n    },\n    {\n      "parameters": {\n        "functionCode": "const mensagem = `OlÃ¡! ðŸ‘‹\\n\\nVocÃª entrou em contato com o *Atendimento Fartech*.\\n\\nEstamos fora do nosso horÃ¡rio de atendimento (segunda a sexta, das 8h Ã s 18h).\\n\\nRegistramos sua mensagem e retornaremos assim que estivermos online.\\n\\nSe for algo urgente (pedido bloqueado, pagamento duplicado, entrega em risco, conta comprometida), responda com *URGENTE* na primeira linha.\\n\\nObrigado pela compreensÃ£o.`;\n\nconst from = $items(\"Normalizar Dados WhatsApp\")[0].json.from;\n\nreturn [{\n  from,\n  resposta: mensagem\n}];"\n      },\n      "id": "msg_off_hour",\n      "name": "Mensagem Fora do HorÃ¡rio",\n      "type": "n8n-nodes-base.function",\n      "typeVersion": 1,\n      "position": [\n        1120,\n        -272\n      ]\n    },\n    {\n      "parameters": {\n        "requestMethod": "POST",\n        "url": "https://www.avisaapi.com.br/api/actions/sendMessage",\n        "options": {\n          "bodyContentType": "json"\n        },\n        "bodyParametersUi": {\n          "parameter": [\n            {\n              "name": "number",\n              "value": "={{ $items(\"Normalizar Dados WhatsApp\")[0].json.from }}"\n            },\n            {\n              "name": "message",\n              "value": "={{ $json.resposta }}"\n            }\n          ]\n        },\n        "headerParametersUi": {\n          "parameter": [\n            {\n              "name": "Authorization",\n              "value": "Bearer 6CSmnzPkmLpPlL6h37J6aHluA9VvUS8f5FqVW9QsVgqmPggEwTvbmJH1PcoJ"\n            }\n          ]\n        }\n      },\n      "id": "avisaapi_off_hour",\n      "name": "AvisaAPI - Enviar Off-Hour",\n      "type": "n8n-nodes-base.httpRequest",\n      "typeVersion": 1,\n      "position": [\n        1392,\n        -272\n      ]\n    },\n    {\n      "parameters": {\n        "functionCode": "const { from } = $json;\nconst rawText = $json.text || \"\";\nconst clean = String(rawText).trim();\nconst isNumero = /^(?:[1-6])$/.test(clean);\n\nlet modo = 'menu';\nlet area = null;\n\nif (isNumero) {\n    modo = 'triagem';\n    switch (clean) {\n        case '1': area = 'Pedido em andamento'; break;\n        case '2': area = 'Trocas e devoluÃ§Ãµes'; break;\n        case '3': area = 'Pagamentos e reembolsos'; break;\n        case '4': area = 'Entregas e rastreamento'; break;\n        case '5': area = 'Conta e seguranÃ§a'; break;\n        case '6': area = 'Lojas parceiras / sellers'; break;\n    }\n}\n\nreturn {\n    from,\n    text: rawText,\n    clean,\n    modo,\n    area\n};"\n      },\n      "id": "analisa_msg",\n      "name": "Analisar Mensagem (Menu ou Ãrea)",\n      "type": "n8n-nodes-base.function",\n      "typeVersion": 1,\n      "position": [\n        608,\n        48\n      ]\n    },\n    {\n      "parameters": {\n        "conditions": {\n          "string": [\n            {\n              "value1": "={{$json[\"modo\"]}}",\n              "value2": "triagem"\n            }\n          ]\n        }\n      },\n      "id": "if_menu_triagem",\n      "name": "IF - Menu ou Triagem?",\n      "type": "n8n-nodes-base.if",\n      "typeVersion": 1,\n      "position": [\n        864,\n        48\n      ]\n    },\n    {\n      "parameters": {\n        "functionCode": "const { from } = $json;\n\nconst mensagem = `OlÃ¡! ðŸ‘‹\\nVocÃª estÃ¡ falando com o suporte da *Fartech*. Escolha uma opÃ§Ã£o digitando apenas o nÃºmero correspondente:\\n\\n1ï¸âƒ£ Pedido em andamento\\n2ï¸âƒ£ Trocas e devoluÃ§Ãµes\\n3ï¸âƒ£ Pagamentos e reembolsos\\n4ï¸âƒ£ Entregas e rastreamento\\n5ï¸âƒ£ Conta e seguranÃ§a\\n6ï¸âƒ£ Lojas parceiras / sellers\\n\\nDigite apenas o nÃºmero da opÃ§Ã£o desejada.`;\n\nreturn [{\n  from,\n  resposta: mensagem\n}];"\n      },\n      "id": "msg_menu",\n      "name": "Mensagem Menu Fartech",\n      "type": "n8n-nodes-base.function",\n      "typeVersion": 1,\n      "position": [\n        1120,\n        176\n      ]\n    },\n    {\n      "parameters": {\n        "requestMethod": "POST",\n        "url": "https://www.avisaapi.com.br/api/actions/sendMessage",\n        "options": {\n          "bodyContentType": "json"\n        },\n        "bodyParametersUi": {\n          "parameter": [\n            {\n              "name": "message",\n              "value": "={{ $json.resposta }}"\n            },\n            {\n              "name": "number",\n              "value": "={{ $items(\"Normalizar Dados WhatsApp\")[0].json.from }}"\n            }\n          ]\n        },\n        "headerParametersUi": {\n          "parameter": [\n            {\n              "name": "Authorization",\n              "value": "Bearer 6CSmnzPkmLpPlL6h37J6aHluA9VvUS8f5FqVW9QsVgqmPggEwTvbmJH1PcoJ"\n            }\n          ]\n        }\n      },\n      "id": "avisaapi_menu",\n      "name": "AvisaAPI - Enviar Menu",\n      "type": "n8n-nodes-base.httpRequest",\n      "typeVersion": 1,\n      "position": [\n        1392,\n        176\n      ]\n    },\n    {\n      "parameters": {\n        "functionCode": "const { from, area } = $json;\n\nconst prompt = `VocÃª Ã© o assistente virtual da *Fartech*, e-commerce premium. Responda em portuguÃªs (Brasil) por WhatsApp.\\n\\nRegras:\\n- Seja breve, cordial e profissional.\\n- NÃ£o prometa prazos que nÃ£o consiga garantir.\\n- FaÃ§a 3 a 4 perguntas objetivas para entender o caso.\\n- Se houver sinais de risco (pagamento duplicado, cobranÃ§a incorreta, acesso suspeito, entrega crÃ­tica), avise que priorizaremos.\\n- NÃ£o peÃ§a dados sensÃ­veis completos (CPF inteiro, cartÃ£o). Apenas dados mÃ­nimos (nÂº do pedido, e-mail da conta, CEP aproximado).\\n\\nÃrea escolhida: ${area}.\\n\\nGere uma mensagem Ãºnica para o cliente seguindo:\\n1) Cumprimente e confirme que Ã© o suporte Fartech.\\n2) Reafirme a categoria (${area}).\\n3) FaÃ§a 3-4 perguntas claras sobre o caso.\\n4) Diga que um especialista darÃ¡ continuidade pelo WhatsApp/e-mail.\\n\\nResponda apenas com a mensagem pronta para enviar.`;\n\nreturn [{\n  from,\n  area,\n  prompt\n}];"\n      },\n      "id": "monta_prompt",\n      "name": "Montar Prompt por Ãrea",\n      "type": "n8n-nodes-base.function",\n      "typeVersion": 1,\n      "position": [\n        1120,\n        -48\n      ]\n    },\n    {\n      "parameters": {\n        "prompt": "={{ $json.prompt }}",\n        "options": {},\n        "requestOptions": {}\n      },\n      "id": "openai_resposta",\n      "name": "OpenAI - Resposta Fartech",\n      "type": "n8n-nodes-base.openAi",\n      "typeVersion": 1,\n      "position": [\n        1392,\n        -48\n      ]\n    },\n    {\n      "parameters": {\n        "functionCode": "const from = $items(\"Montar Prompt por Ãrea\")[0].json.from;\nlet resposta = $json.text;\n\nif (!resposta || resposta.trim() === \"\") {\n    resposta = \"No momento nÃ£o consegui gerar uma resposta automÃ¡tica. Por favor, tente novamente em instantes ou aguarde nosso suporte humano.\";\n}\n\nreturn [{\n    from,\n    resposta\n}];"\n      },\n      "id": "extrai_ia",\n      "name": "Extrair Texto IA",\n      "type": "n8n-nodes-base.function",\n      "typeVersion": 1,\n      "position": [\n        1648,\n        -48\n      ]\n    },\n    {\n      "parameters": {\n        "amount": 1.5,\n        "unit": "seconds"\n      },\n      "id": "wait_ia",\n      "name": "Digitando IA (1.5s)",\n      "type": "n8n-nodes-base.wait",\n      "typeVersion": 1,\n      "position": [\n        1760,\n        -48\n      ]\n    },\n    {\n      "parameters": {\n        "requestMethod": "POST",\n        "url": "https://www.avisaapi.com.br/api/actions/sendMessage",\n        "options": {\n          "bodyContentType": "json"\n        },\n        "bodyParametersUi": {\n          "parameter": [\n            {\n              "name": "number",\n              "value": "={{ $items(\"Normalizar Dados WhatsApp\")[0].json.from }}"\n            },\n            {\n              "name": "message",\n              "value": "={{ $json.resposta }}"\n            }\n          ]\n        },\n        "headerParametersUi": {\n          "parameter": [\n            {\n              "name": "Authorization",\n              "value": "Bearer 6CSmnzPkmLpPlL6h37J6aHluA9VvUS8f5FqVW9QsVgqmPggEwTvbmJH1PcoJ"\n            }\n          ]\n        }\n      },\n      "id": "avisaapi_resposta",\n      "name": "AvisaAPI - Enviar Resposta IA",\n      "type": "n8n-nodes-base.httpRequest",\n      "typeVersion": 1,\n      "position": [\n        1904,\n        -48\n      ]\n    }\n  ],\n  "pinData": {},\n  "connections": {\n    "Normalizar Dados WhatsApp": {\n      "main": [[\n        {"node": "Analisar Mensagem (Menu ou Ãrea)", "type": "main", "index": 0}\n      ]]\n    },\n    "Verificar HorÃ¡rio Comercial": {\n      "main": [[\n        {"node": "IF - Dentro do HorÃ¡rio?", "type": "main", "index": 0}\n      ]]\n    },\n    "IF - Dentro do HorÃ¡rio?": {\n      "main": [\n        [{"node": "Analisar Mensagem (Menu ou Ãrea)", "type": "main", "index": 0}],\n        [{"node": "Mensagem Fora do HorÃ¡rio", "type": "main", "index": 0}]\n      ]\n    },\n    "Mensagem Fora do HorÃ¡rio": {\n      "main": [[\n        {"node": "AvisaAPI - Enviar Off-Hour", "type": "main", "index": 0}\n      ]]\n    },\n    "Analisar Mensagem (Menu ou Ãrea)": {\n      "main": [[\n        {"node": "IF - Menu ou Triagem?", "type": "main", "index": 0}\n      ]]\n    },\n    "IF - Menu ou Triagem?": {\n      "main": [\n        [{"node": "Montar Prompt por Ãrea", "type": "main", "index": 0}],\n        [{"node": "Mensagem Menu Fartech", "type": "main", "index": 0}]\n      ]\n    },\n    "Mensagem Menu Fartech": {\n      "main": [[\n        {"node": "Digitando Menu (1.5s)", "type": "main", "index": 0}\n      ]]\n    },\n    "Digitando Menu (1.5s)": {\n      "main": [[\n        {"node": "AvisaAPI - Enviar Menu", "type": "main", "index": 0}\n      ]]\n    },\n    "Montar Prompt por Ãrea": {\n      "main": [[\n        {"node": "OpenAI - Resposta Fartech", "type": "main", "index": 0}\n      ]]\n    },\n    "OpenAI - Resposta Fartech": {\n      "main": [[\n        {"node": "Extrair Texto IA", "type": "main", "index": 0}\n      ]]\n    },\n    "Extrair Texto IA": {\n      "main": [[\n        {"node": "Digitando IA (1.5s)", "type": "main", "index": 0}\n      ]]\n    },\n    "Digitando IA (1.5s)": {\n      "main": [[\n        {"node": "AvisaAPI - Enviar Resposta IA", "type": "main", "index": 0}\n      ]]\n    },\n    "Webhook": {\n      "main": [[\n        {"node": "Normalizar Dados WhatsApp", "type": "main", "index": 0}\n      ]]\n    }\n  },\n  "active": false,\n  "settings": {\n    "executionOrder": "v1"\n  },\n  "tags": []\n}
